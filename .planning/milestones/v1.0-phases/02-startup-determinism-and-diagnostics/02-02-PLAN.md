---
phase: 02-startup-determinism-and-diagnostics
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - docker-entrypoint.sh
autonomous: true
requirements:
  - STRT-01
  - STRT-02
user_setup: []
must_haves:
  truths:
    - Entrypoint enforces deterministic startup ordering: teamserver readiness gate before REST startup.
    - Startup readiness and early-exit paths return non-zero with clear process-specific cause.
  artifacts:
    - docker-entrypoint.sh
  key_links:
    - Teamserver TLS readiness gate must complete before csrestapi launch path.
    - Startup wait loops include process-liveness checks and explicit timeout failures.
---

<objective>
Strengthen entrypoint startup sequencing and failure semantics to satisfy STRT-01 and STRT-02 with deterministic branch behavior.

Purpose: make startup path robust under transient failure and process-exit races.
Output: reusable readiness/failure helpers and explicit non-zero exits for startup failure branches.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/02-startup-determinism-and-diagnostics/02-CONTEXT.md
@.planning/phases/02-startup-determinism-and-diagnostics/02-RESEARCH.md
@.planning/phases/02-startup-determinism-and-diagnostics/02-01-PLAN.md

@docker-entrypoint.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor startup probes into deterministic gate helpers</name>
  <files>docker-entrypoint.sh</files>
  <action>Create helper functions that run bounded readiness loops with probe labels, timeout handling, and process-liveness guards. Reuse for teamserver TLS and REST health readiness paths.</action>
  <verify>rg -n "wait_for_teamserver_ready|wait_for_rest_ready|timeout|kill -0" docker-entrypoint.sh</verify>
  <done>Readiness gates share deterministic behavior and fail consistently with phase-aware messaging.</done>
</task>

<task type="auto">
  <name>Task 2: Harden startup exit semantics for process death during gates</name>
  <files>docker-entrypoint.sh</files>
  <action>Ensure any unexpected teamserver/csrestapi exit during startup or monitor transition produces explicit non-zero exit status with process-specific cause text.</action>
  <verify>rg -n "exited before|exited while|exit 1|wait -n" docker-entrypoint.sh</verify>
  <done>All unexpected startup process exits are classified and return non-zero with actionable error context.</done>
</task>

<task type="auto">
  <name>Task 3: Validate refactored entrypoint sequencing invariants</name>
  <files>docker-entrypoint.sh</files>
  <action>Run syntax checks and inspect sequence markers to confirm csrestapi launch remains gated on teamserver readiness and startup invariants were not loosened.</action>
  <verify>bash -n /opt/Cobalt-Docker/docker-entrypoint.sh && rg -n "teamserver|csrestapi|TLS|health" docker-entrypoint.sh</verify>
  <done>Entrypoint sequencing remains strict and passes shell syntax checks after refactor.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n /opt/Cobalt-Docker/docker-entrypoint.sh` passes
- [ ] teamserver readiness gate precedes REST startup in all branches
- [ ] unexpected startup process exits are non-zero and clearly reported
</verification>

<success_criteria>
- STRT-01 and STRT-02 are satisfied via deterministic startup gate behavior.
- Failure branches are explicit and operator-actionable.
- Startup sequencing remains unchanged in intent but improved in reliability.
</success_criteria>

<output>
After completion, create `.planning/phases/02-startup-determinism-and-diagnostics/02-02-SUMMARY.md`
</output>
