---
phase: 02-startup-determinism-and-diagnostics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cobalt-docker.sh
  - .env.example
  - README.md
autonomous: true
requirements:
  - CONF-03
user_setup: []
must_haves:
  truths:
    - Launcher validates startup-critical runtime port and boolean controls before build/run.
    - Invalid runtime control values fail fast with explicit actionable remediation.
  artifacts:
    - cobalt-docker.sh
    - .env.example
    - README.md
  key_links:
    - Launcher validation behavior matches documented runtime control contract.
    - Template/default examples remain compatible with strict control validation.
---

<objective>
Harden launcher runtime-control validation so startup failures are deterministic and operator-actionable before container startup.

Purpose: satisfy CONF-03 by removing malformed control ambiguity and normalizing validation behavior.
Output: reusable validation helpers in launcher, strict boolean/port checks, and docs/template alignment.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/02-startup-determinism-and-diagnostics/02-CONTEXT.md
@.planning/phases/02-startup-determinism-and-diagnostics/02-RESEARCH.md

@cobalt-docker.sh
@.env.example
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Centralize launcher validation helpers for runtime controls</name>
  <files>cobalt-docker.sh</files>
  <action>Add reusable shell helpers for integer-port and boolean validation/normalization, then route existing runtime control checks through those helpers for deterministic error output.</action>
  <verify>rg -n "require_valid_port|normalize_bool_setting|REST_API_PUBLISH_PORT|SERVICE_PORT|UPSTREAM_PORT|HEALTHCHECK_INSECURE" cobalt-docker.sh</verify>
  <done>Validation logic is centralized and startup-critical controls share consistent failure messaging.</done>
</task>

<task type="auto">
  <name>Task 2: Enforce boolean contract for Tailscale runtime toggles</name>
  <files>cobalt-docker.sh, .env.example</files>
  <action>Validate and normalize `TS_USERSPACE` and `USE_TAILSCALE_IP` to strict `true|false` semantics while preserving safe defaults for empty values.</action>
  <verify>rg -n "TS_USERSPACE|USE_TAILSCALE_IP|must be 'true' or 'false'" cobalt-docker.sh .env.example</verify>
  <done>Tailscale boolean controls are deterministic and invalid values fail preflight with remediation.</done>
</task>

<task type="auto">
  <name>Task 3: Align README runtime control guidance to enforced validation</name>
  <files>README.md</files>
  <action>Document strict runtime control validation behavior (ports/booleans) and expected failure outcomes so operators can self-correct malformed values quickly.</action>
  <verify>rg -n "Failure Conditions|HEALTHCHECK_INSECURE|TS_USERSPACE|USE_TAILSCALE_IP|1 to 65535" README.md</verify>
  <done>README accurately reflects launcher validation behavior for startup controls.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n /opt/Cobalt-Docker/cobalt-docker.sh` passes
- [ ] Launcher rejects malformed boolean/port control values with actionable errors
- [ ] Template/docs stay consistent with enforced validation contract
</verification>

<success_criteria>
- CONF-03 is implemented with deterministic validation coverage.
- Invalid runtime controls never reach container startup path.
- Operator remediation path is explicit and documented.
</success_criteria>

<output>
After completion, create `.planning/phases/02-startup-determinism-and-diagnostics/02-01-SUMMARY.md`
</output>
