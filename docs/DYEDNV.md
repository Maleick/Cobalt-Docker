# DyeDNV v1 Specification

This document defines the `dyednv.v1` file generated by `scripts/dyednv-wizard.sh`.

## Purpose

DyeDNV is a deployment specification format for this repository. It collects runtime and governance-relevant deployment inputs in one JSON document without writing secrets directly.

Generation command:

```bash
./scripts/dyednv-wizard.sh
```

Default output path:

```text
configs/dyednv/<name>.dyednv.json
```

## Secret Handling Rule

DyeDNV stores secret references, not raw secret values.

- Allowed: `vault://teamserver/password`, `secret://cobaltstrike/license`
- Rejected by wizard: values that look like raw secrets (for example `tskey-...`, `sk-...`, `ghp_...`, `AKIA...`, PEM private keys)

## Top-Level Schema

```json
{
  "schema_version": "dyednv.v1",
  "metadata": {},
  "teamserver": {},
  "runtime": {},
  "rest_api": {},
  "tailscale": {},
  "secret_refs": {}
}
```

## Field Contract

| Dataset | Fields | Required | Validation |
|---|---|---:|---|
| `metadata` | `name`, `environment`, `owner`, `created_at_utc` | yes | `name` slug-safe, timestamp generated by wizard |
| `teamserver` | `external_host`, `profile_name`, `profile_intent` | yes except `profile_name` | metadata only for profile scope |
| `runtime` | `docker_platform`, `mount_source`, `teamserver_host_override` | `docker_platform` yes | non-empty string for required values |
| `rest_api` | `rest_api_user`, `publish_bind`, `publish_port`, `service_bind_host`, `service_port`, `upstream_host`, `upstream_port`, `healthcheck_url`, `healthcheck_insecure` | yes | ports `1..65535`, booleans `true/false` |
| `tailscale` | `enabled`, `ts_userspace`, `use_tailscale_ip`, `ts_extra_args` | yes | booleans `true/false` |
| `secret_refs` | `cobaltstrike_license_ref`, `teamserver_password_ref`, `ts_authkey_ref`, `ts_api_key_ref` | first two yes | `scheme://value`, raw-secret patterns rejected |

## Example

```json
{
  "schema_version": "dyednv.v1",
  "metadata": {
    "name": "acme-prod",
    "environment": "prod",
    "owner": "operator",
    "created_at_utc": "2026-02-25T22:00:00Z"
  },
  "teamserver": {
    "external_host": "10.42.99.10",
    "profile_name": "ops.profile",
    "profile_intent": "baseline-profile"
  },
  "runtime": {
    "docker_platform": "linux/amd64",
    "mount_source": "/opt/Cobalt-Docker",
    "teamserver_host_override": ""
  },
  "rest_api": {
    "rest_api_user": "csrestapi",
    "publish_bind": "127.0.0.1",
    "publish_port": 50443,
    "service_bind_host": "0.0.0.0",
    "service_port": 50443,
    "upstream_host": "127.0.0.1",
    "upstream_port": 50050,
    "healthcheck_url": "https://127.0.0.1:50443/health",
    "healthcheck_insecure": true
  },
  "tailscale": {
    "enabled": false,
    "ts_userspace": false,
    "use_tailscale_ip": false,
    "ts_extra_args": ""
  },
  "secret_refs": {
    "cobaltstrike_license_ref": "secret://cobaltstrike/license",
    "teamserver_password_ref": "secret://teamserver/password",
    "ts_authkey_ref": "",
    "ts_api_key_ref": ""
  }
}
```

## Notes

- Wizard generation is intentionally side-effect free:
  - no `.env` writes
  - no Docker calls
  - no deployment actions
- Resolve secret references with your own secret-management workflow, then apply resolved values manually to `.env` before running `./cobalt-docker.sh`.
